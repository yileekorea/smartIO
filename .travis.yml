language: python
python:
- '2.7'
sudo: false
cache:
  directories:
  - "~/.platformio"

env:
- PLATFORMIO_CI_SRC=src/

install:
- pip install -U platformio
#- platformio lib install 567 562
- platformio platform install espressif8266 
#--with-package tool-mklittlefs
script:
  - platformio --version
  - platformio run -e smartIO_deploy
  - platformio run -t buildfs -e smartIO_deploy

  - RELEASE_VER="R.0.0.1"
  #- LOCAL_VER="local.0.0.6"
  - echo $TRAVIS_BRANCH / $RELEASE_VER

after_success:

  # CREATE GIT TAG
  - git config --global user.email "builds@travis-ci.com"
  - git config --global user.name "Travis CI"
  #- export GIT_TAG=build-$TRAVIS_BRANCH-$(date -u "+%Y-%m-%d-%H-%M-%S")-$TRAVIS_BUILD_NUMBER
  #- export GIT_TAG=build-$TRAVIS_BRANCH-$(date -u "+%Y-%m-%d")-$TRAVIS_BUILD_NUMBER
  #- export GIT_TAG=$RELEASE_VER-$TRAVIS_BRANCH-$(date -u "+%Y-%m-%d")-$TRAVIS_BUILD_NUMBER
  - export GIT_TAG=$RELEASE_VER-$TRAVIS_BRANCH-$(date "+%Y-%m-%d")-$TRAVIS_BUILD_NUMBER
  - echo -n $GIT_TAG > public/version
  - git commit -m "Set build VERSION number" public/version
  - git tag $GIT_TAG -a -m "Generated tag from TravisCI build $TRAVIS_BUILD_NUMBER"
  - git push --quiet https://$GITHUBKEY@github.com/yileekorea/smartIO $GIT_TAG > /dev/null 2>&1
  - echo $TRAVIS_TAG

#branches: true
  #except:
    #- /^build-[0-9a-z\-]*/

deploy:
  provider: releases
  skip_cleanup: true
  overwrite: true
  file:
  #- ".pioenvs/smartIO_deploy/firmware.bin"
  #- ".pioenvs/smartIO_deploy/spiffs.bin"
  - ".pio/build/smartIO_deploy/firmware.bin"
  #- ".pio/build/smartIO_deploy/spiffs.bin"
  on:
    repo: yileekorea/smartIO
    all_branches: true
    #condition: $TRAVIS_TAG =~ ^[0-9]+\.[0-9]+\.[0-9]+$
    #condition: $TRAVIS_TAG =0.0.4
    #condition: $BRANCH_FOR_TAG =~ (pre|alpha|beta|rc)-[0-9]+$
    #condition: $TRAVIS_TAG =~ (pre|alpha|beta|build-master)[0-9]+\.[0-9]+\.[0-9]+$
    #condition: $TRAVIS_TAG =~ (pre|alpha|beta|build-)+$
    #condition: $TRAVIS_TAG =~ v[0-9]+\.[0-9]+\.[0-9]+*$

    #~ 2020 11 12
    #condition: $RELEASE_VER =~ ^(release.)[0-9]+\.[0-9]+\.[0-9]+$
    condition: $RELEASE_VER =~ ^(R.)[0-9]+\.[0-9]+\.[0-9]+$

  api-key:
#    secure: wxyk/rYpKd0VcmS3Ogs1QZdhd02//Au6n6kFnrwt83ClgXsH8HC6FiLRqyi1Jr3kkbotWAPHLngosxSwM9liiQ9hjLpP8XMYkn5CkLs+QuXJq7Wwo8ECsYdj5AInI1eUDjjHCOBWjUAcPQ9GaHzCE/FGnycfPbL+U6VuKz1ZtGZxqGxvQ9yRK5xvCNwz8ZfBaSGUZJL9LKQCck4h/XwX7DajbEzgDq7rflByVb/71KRxJQr+KDZPgqtO3Ej5a/6guFm/PRdY7YJ7Yyc6v9T6eILvc+UrcApnP0FIqIdTsLlUEpj/EdvCp6K3+WnCiy1EVORg28T33VO0bXUemP+Fd7LMvyrqxivcTJm1jGlZ7zGqSkUQzC+uy3GLzr1pTkRVHErdKSdN38+PJow3ut/w3Tcqd6QYt79jd8oeIgn2ZUzUASUzT+lPS7nBZfqbVRyEYqNt8SQM+egebzCQdf3CcCZK+8RAX9TKyoOKQ5mllHo58phM02FdAIYgEcF8aAaEFi/aO5+89uMSA9+emx1UpPY/jjK5lNLRIPbeIbiIezX1QOykoThLnsHupTUm2ZU5OCL+BMy+74DaqeNLHwcl2oRz2eKMDVPJ59jmTJ7rfJQAF1wmx+4NwpkhJMRQ3gZPba4rFMB7wkh0+Wbt4qT7bNqg1VtsQfnr5q1mnwRIJxU=
    secure: fFMqU/DTRWIol1G+ACbIV9bGF8w4pWEztPUFbv+MpdHi8AP3fR1BDTRti/8e+IvigdJnZGno9IcYnm9nt+TRD1Fa4gsFZAIFUaSTZx9fqcqGsVQmFuQ+K4JszfS5lvdBBuz+EcvDlpqGJb1SoJCSidbHLH6f9Rbn2SuaRYf0q3qPUtoUTdlqhH7fLxq/lKwbWkEtu3WbHRyT9M0wn2afFn5yvUFsgFmR3Vrmifjr+/2gkUZNAA30AzXmIlq+r2H2vpCYOIXR8m7TWmjrq6Y1r+j3GqhJDzNBMTuFUOGw2nCa/B7YP48IMJRGARIZ2bCoL1lTQsm4Pxl3zyz3XY3zR0f3kFdNS7Hjv1xM3gILs7aGS2Zf1fARstEaZVellKEQSuNt06U0RgmvNzB/MzflyZ7P7a1LP8pYLQRSe6RMjFlMkhUy0l5sn+9TWBbZ0m2zeIZ7GR+02kMF/4JbGE6Fdq/M5T5ntsjVeReNNeJq1419Nw9qQktSyAru+rj9w5gwhzgH1W7uFgbeyrzwi96uc6WaIGOhzCeadx+XdvQ/RD6NFnf6a4htN4yKdY8FmfLg6+l5sI7lLl1S9ThnDpOtokd8bCea0awwgGe04WCtq3Mrro0nt4Yfgs/igFu0EWwV+5buxshNAQ+a79m7nbigWLBk5IK1pgYiuYcOgID0c+I=
    
